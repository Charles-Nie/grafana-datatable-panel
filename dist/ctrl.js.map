{"version":3,"sources":["../src/ctrl.js"],"names":["MetricsPanelCtrl","$","moment","kbn","DataTable","FileExport","transformDataToTable","transformers","panelDefaults","targets","transform","pageSize","showHeader","styles","type","pattern","dateFormat","unit","decimals","colors","colorMode","thresholds","columns","scroll","fontSize","sort","col","desc","DatatablePanelCtrl","$scope","$injector","$http","$location","uiSegmentSrv","annotationsSrv","pageIndex","table","dataRaw","addColumnSegment","newPlusButton","fontSizes","colorModes","text","value","columnTypes","unitFormats","getUnitFormats","dateFormats","getColumnNames","panelCtrl","_","map","panel","fields","defaults","dataLoaded","http","events","on","onDataReceived","bind","onDataError","onInitEditMode","onInitPanelActions","actions","push","click","panels","grafanaBootData","settings","thisPanel","pluginId","thisPanelPath","baseUrl","optionsPath","addEditorTab","datasource","setTimeQueryStart","getAnnotations","dashboard","range","then","data","annotations","err","render","dataList","length","renderer","TableRenderer","isTimezoneUtc","$sanitize","exportTableDataToCsv","render_values","scope","elem","attrs","ctrl","formatters","_this","renderPanel","columnDefs","i","title","full","meta","response","undefined","utc","toISOString","replace","null","should_destroy","fn","dataTable","isDataTable","aDT","destroy","empty","console","log","message","rows","renderData","renderingCompleted","column","without","$q","when","getColumns","segments","c","newSegment","find","plusButton","html","style","subItem","index","ref","copy","templateUrl"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACEA,sB,kBAAAA,gB;;AAEKC,O;;AACAC,Y;;AACAC,S;;AAEAC,e;;AAKKC,gB;;AAGVC,0B,iBAAAA,oB;AACAC,kB,iBAAAA,Y;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAGIC,mB,GAAgB;AACpBC,iBAAS,CAAC,EAAD,CADW;AAEpBC,mBAAW,uBAFS;AAGpBC,kBAAU,IAHU;AAIpBC,oBAAY,IAJQ;AAKpBC,gBAAQ,CACN;AACEC,gBAAM,MADR;AAEEC,mBAAS,MAFX;AAGEC,sBAAY;AAHd,SADM,EAMN;AACEC,gBAAM,OADR;AAEEH,gBAAM,QAFR;AAGEI,oBAAU,CAHZ;AAIEC,kBAAQ,CAAC,wBAAD,EAA2B,0BAA3B,EAAuD,yBAAvD,CAJV;AAKEC,qBAAW,IALb;AAMEL,mBAAS,MANX;AAOEM,sBAAY;AAPd,SANM,CALY;AAqBpBC,iBAAS,EArBW;AAsBpBC,gBAAQ,IAtBY;AAuBpBC,kBAAU,MAvBU;AAwBpBC,cAAM;AACJC,eAAK,CADD;AAEJC,gBAAM;AAFF;AAxBc,O;;oCA8BTC,kB;;;AAEX,oCAAYC,MAAZ,EAAoBC,SAApB,EAA+BC,KAA/B,EAAsCC,SAAtC,EAAiDC,YAAjD,EAA+DC,cAA/D,EAA+E;AAAA;;AAAA,+IACvEL,MADuE,EAC/DC,SAD+D;;AAE7E,iBAAKK,SAAL,GAAiB,CAAjB;AACA,iBAAKC,KAAL,GAAa,IAAb;AACA,iBAAKC,OAAL,GAAe,EAAf;AACA,iBAAK9B,YAAL,GAAoBA,YAApB;AACA,iBAAK2B,cAAL,GAAsBA,cAAtB;AACA,iBAAKD,YAAL,GAAoBA,YAApB;AACA;;AAEA,iBAAKK,gBAAL,GAAwBL,aAAaM,aAAb,EAAxB;AACA,iBAAKC,SAAL,GAAiB,CAAC,KAAD,EAAQ,KAAR,EAAe,MAAf,EAAuB,MAAvB,EAA+B,MAA/B,EAAuC,MAAvC,EAA+C,MAA/C,EAAuD,MAAvD,EAA+D,MAA/D,EAAuE,MAAvE,EAA+E,MAA/E,EAAuF,MAAvF,CAAjB;AACA,iBAAKC,UAAL,GAAkB,CAChB;AACEC,kBAAM,UADR;AAEEC,mBAAO;AAFT,WADgB,EAKhB;AACED,kBAAM,MADR;AAEEC,mBAAO;AAFT,WALgB,EAShB;AACED,kBAAM,OADR;AAEEC,mBAAO;AAFT,WATgB,EAahB;AACED,kBAAM,KADR;AAEEC,mBAAO;AAFT,WAbgB,CAAlB;AAkBA,iBAAKC,WAAL,GAAmB,CACjB;AACEF,kBAAM,QADR;AAEEC,mBAAO;AAFT,WADiB,EAKjB;AACED,kBAAM,QADR;AAEEC,mBAAO;AAFT,WALiB,EASjB;AACED,kBAAM,MADR;AAEEC,mBAAO;AAFT,WATiB,EAajB;AACED,kBAAM,QADR;AAEEC,mBAAO;AAFT,WAbiB,CAAnB;AAkBA,iBAAKE,WAAL,GAAmB1C,IAAI2C,cAAJ,EAAnB;AACA,iBAAKC,WAAL,GAAmB,CACjB;AACEL,kBAAM,qBADR;AAEEC,mBAAO;AAFT,WADiB,EAKjB;AACED,kBAAM,oBADR;AAEEC,mBAAO;AAFT,WALiB,EASjB;AACED,kBAAM,iBADR;AAEEC,mBAAO;AAFT,WATiB,CAAnB;AAcA;AACA,iBAAKK,cAAL,GAAsB,YAAM;AAC1B,gBAAI,CAAC,OAAKC,SAAL,CAAeb,KAApB,EAA2B;AACzB,qBAAO,EAAP;AACD;AACD,mBAAOc,EAAEC,GAAF,CAAM,OAAKF,SAAL,CAAeb,KAAf,CAAqBd,OAA3B,EAAoC,UAASI,GAAT,EAAc;AACvD,qBAAOA,IAAIgB,IAAX;AACD,aAFM,CAAP;AAGD,WAPD;;AASA,cAAI,OAAKU,KAAL,CAAWvC,MAAX,KAAsB,KAAK,CAA/B,EAAkC;AAChC,mBAAKuC,KAAL,CAAWvC,MAAX,GAAoB,OAAKuC,KAAL,CAAW9B,OAA/B;AACA,mBAAK8B,KAAL,CAAW9B,OAAX,GAAqB,OAAK8B,KAAL,CAAWC,MAAhC;AACA,mBAAO,OAAKD,KAAL,CAAW9B,OAAlB;AACA,mBAAO,OAAK8B,KAAL,CAAWC,MAAlB;AACD;AACDH,YAAEI,QAAF,CAAW,OAAKF,KAAhB,EAAuB5C,aAAvB;;AAEA,iBAAK+C,UAAL,GAAkB,IAAlB;AACA,iBAAKC,IAAL,GAAYzB,KAAZ;;AAEA,iBAAK0B,MAAL,CAAYC,EAAZ,CAAe,eAAf,EAAgC,OAAKC,cAAL,CAAoBC,IAApB,QAAhC;AACA,iBAAKH,MAAL,CAAYC,EAAZ,CAAe,YAAf,EAA6B,OAAKG,WAAL,CAAiBD,IAAjB,QAA7B;AACA,iBAAKH,MAAL,CAAYC,EAAZ,CAAe,oBAAf,EAAqC,OAAKC,cAAL,CAAoBC,IAApB,QAArC;AACA,iBAAKH,MAAL,CAAYC,EAAZ,CAAe,gBAAf,EAAiC,OAAKI,cAAL,CAAoBF,IAApB,QAAjC;AACA,iBAAKH,MAAL,CAAYC,EAAZ,CAAe,oBAAf,EAAqC,OAAKK,kBAAL,CAAwBH,IAAxB,QAArC;;AAxF6E;AA0F9E;;;;6CAEkBI,O,EAAS;AACxBA,oBAAQC,IAAR,CAAa;AACXvB,oBAAM,YADK;AAEXwB,qBAAO;AAFI,aAAb;AAID;;;2CAEc;AACf;AACA,gBAAIC,SAASC,gBAAgBC,QAAhB,CAAyBF,MAAtC;AACA,gBAAIG,YAAYH,OAAO,KAAKI,QAAZ,CAAhB;AACA,gBAAIC,gBAAgBF,UAAUG,OAAV,GAAoB,GAAxC;AACA;AACA,gBAAIC,cAAcF,gBAAgB,8BAAlC;AACA,iBAAKG,YAAL,CAAkB,SAAlB,EAA6BD,WAA7B,EAA0C,CAA1C;AACD;;;uCAEYE,U,EAAY;AACvB,iBAAKzC,SAAL,GAAiB,CAAjB;AACA,gBAAI,KAAKiB,KAAL,CAAW1C,SAAX,KAAyB,aAA7B,EAA4C;AAC1C,mBAAKmE,iBAAL;AACA,qBAAO,KAAK3C,cAAL,CAAoB4C,cAApB,CAAmC;AACtCC,2BAAW,KAAKA,SADsB;AAEtC3B,uBAAO,KAAKA,KAF0B;AAGtC4B,uBAAO,KAAKA;AAH0B,eAAnC,EAKJC,IALI,CAKC,uBAAe;AACnB,uBAAO;AACLC,wBAAMC;AADD,iBAAP;AAGD,eATI,CAAP;AAUD;AACD,wJAA0BP,UAA1B;AACD;;;sCAEWQ,G,EAAK;AACf,iBAAK/C,OAAL,GAAe,EAAf;AACA,iBAAKgD,MAAL;AACD;;;yCAEcC,Q,EAAU;AACvB,iBAAKjD,OAAL,GAAeiD,QAAf;AACA,iBAAKnD,SAAL,GAAiB,CAAjB;;AAEA;AACA,gBAAI,KAAKE,OAAL,IAAgB,KAAKA,OAAL,CAAakD,MAAjC,EAAyC;AACvC,kBAAI,KAAKlD,OAAL,CAAa,CAAb,EAAgBvB,IAAhB,KAAyB,OAA7B,EAAsC;AACpC,qBAAKsC,KAAL,CAAW1C,SAAX,GAAuB,OAAvB;AACD,eAFD,MAEO;AACL,oBAAI,KAAK2B,OAAL,CAAa,CAAb,EAAgBvB,IAAhB,KAAyB,MAA7B,EAAqC;AACnC,uBAAKsC,KAAL,CAAW1C,SAAX,GAAuB,MAAvB;AACD,iBAFD,MAEO;AACL,sBAAI,KAAK0C,KAAL,CAAW1C,SAAX,KAAyB,OAAzB,IAAoC,KAAK0C,KAAL,CAAW1C,SAAX,KAAyB,MAAjE,EAAyE;AACvE,yBAAK0C,KAAL,CAAW1C,SAAX,GAAuB,oBAAvB;AACD;AACF;AACF;AACF;AACD,iBAAK2E,MAAL;AACD;;;mCAEQ;AACP,iBAAKjD,KAAL,GAAa9B,qBAAqB,KAAK+B,OAA1B,EAAmC,KAAKe,KAAxC,CAAb;AACA,iBAAKhB,KAAL,CAAWX,IAAX,CAAgB,KAAK2B,KAAL,CAAW3B,IAA3B;AACA,kJAAoB,KAAKW,KAAzB;AACD;;;sCAEW;AACV,gBAAIoD,WAAW,IAAIC,aAAJ,CAAkB,KAAKrC,KAAvB,EAA8B,KAAKhB,KAAnC,EAA0C,KAAK2C,SAAL,CAAeW,aAAf,EAA1C,EAA0E,KAAKC,SAA/E,CAAf;AACAtF,uBAAWuF,oBAAX,CAAgCJ,SAASK,aAAT,EAAhC;AACD;;;+BAEIC,K,EAAOC,I,EAAMC,K,EAAOC,I,EAAM;AAC7B,gBAAIf,IAAJ;AACA,gBAAI9B,QAAQ6C,KAAK7C,KAAjB;AACA,gBAAI8C,aAAa,EAAjB;AACA,gBAAIC,QAAQ,IAAZ;;AAEA,qBAASC,WAAT,GAAuB;;AAErB,kBAAID,MAAM/D,KAAN,CAAYd,OAAZ,CAAoBiE,MAApB,KAA+B,CAAnC,EAAsC;AACtC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,kBAAIjE,UAAU,EAAd;AACA,kBAAI+E,aAAa,EAAjB;AACA,mBAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIH,MAAM/D,KAAN,CAAYd,OAAZ,CAAoBiE,MAAxC,EAAgDe,GAAhD,EAAqD;AACnD;AACAhF,wBAAQ2C,IAAR,CAAa;AACXsC,yBAAOJ,MAAM/D,KAAN,CAAYd,OAAZ,CAAoBgF,CAApB,EAAuB5D,IADnB;AAEX5B,wBAAMqF,MAAM/D,KAAN,CAAYd,OAAZ,CAAoBgF,CAApB,EAAuBxF;AAFlB,iBAAb;AAIA,oBAAIqF,MAAM/D,KAAN,CAAYd,OAAZ,CAAoBgF,CAApB,EAAuBxF,IAAvB,KAAgC,IAApC,EAA0C;AACxC,0BAAQqF,MAAM/D,KAAN,CAAYd,OAAZ,CAAoBgF,CAApB,EAAuBxF,IAA/B;AACE,yBAAK,MAAL;AACEuF,iCAAWpC,IAAX,CACE;AACE,gCAAQ,MADV;AAEE,mCAAWqC,CAFb;AAGE,kCAAU,gBAASpB,IAAT,EAAepE,IAAf,EAAqB0F,IAArB,EAA2BC,IAA3B,EAAiC;AACzC,8BAAIC,WAAWxB,IAAf;AACA,8BAAI;AACF;AACA,gCAAIA,SAASyB,SAAb,EAAwB;AACtB,qCAAO,IAAP;AACD;AACDD,uCAAWxG,OAAO0G,GAAP,CAAW1B,IAAX,EAAiB,GAAjB,EAAsB2B,WAAtB,GAAoCC,OAApC,CAA4C,GAA5C,EAAiD,GAAjD,EAAsDA,OAAtD,CAA8D,GAA9D,EAAmE,EAAnE,CAAX;AACD,2BAND,CAME,OAAO1B,GAAP,EAAY;AACZ,mCAAOsB,QAAP;AACD;AACD,iCAAOA,QAAP;AACD;AAfH,uBADF;AAmBA;AACF;AACEL,iCAAWpC,IAAX,CAAgB,EAAC8C,UAAD,EAAhB;AACA;AAxBJ;AA0BD,iBA3BD,MA2BO;AACLV,6BAAWpC,IAAX,CAAgB,EAAC8C,UAAD,EAAhB;AACD;AACF;;AAED,kBAAI;AACF,oBAAIC,iBAAiB,KAArB;AACA,oBAAK/G,EAAEgH,EAAF,CAAKC,SAAL,CAAeC,WAAf,CAA4B,wBAA5B,CAAL,EAA4D;AAC1DH,mCAAiB,IAAjB;AACD;AACD,oBAAIA,cAAJ,EAAoB;AAClB,sBAAII,MAAMnH,EAAE,wBAAF,EAA4BG,SAA5B,EAAV;AACAgH,sBAAIC,OAAJ;AACApH,oBAAE,wBAAF,EAA4BqH,KAA5B;AACD;AACF,eAVD,CAWA,OAAMlC,GAAN,EAAW;AACTmC,wBAAQC,GAAR,CAAY,gBAAgBpC,IAAIqC,OAAhC;AACD;AACD;AACA;AACA;AACA,kBAAItB,MAAM/D,KAAN,CAAYsF,IAAZ,CAAiB,CAAjB,EAAoBnC,MAApB,KAA+B,CAAnC,EAAsC;AACpC,oBAAIY,MAAM/D,KAAN,CAAYsF,IAAZ,CAAiB,CAAjB,EAAoB,CAApB,MAA2Bf,SAA/B,EAA0C;AACxC;AACAR,wBAAM/D,KAAN,CAAYsF,IAAZ,GAAmB,EAAnB;AACD;AACF;AACDzH,gBAAE,wBAAF,EAA4BG,SAA5B,CAAsC;AACpC8E,sBAAMiB,MAAM/D,KAAN,CAAYsF,IADkB;AAEpCrB,4BAAYA,UAFwB;AAGpC/E,yBAASA;AAH2B,eAAtC;;AAMA6E,oBAAM5C,UAAN,GAAmB,IAAnB;AACAgE,sBAAQC,GAAR,CAAY,mBAAZ;AACD;;AAEDvB,iBAAKxC,MAAL,CAAYC,EAAZ,CAAe,QAAf,EAAyB,UAASiE,UAAT,EAAqB;AAC5CzC,qBAAOyC,cAAczC,IAArB;AACA,kBAAIA,IAAJ,EAAU;AACRkB;AACD;AACDH,mBAAK2B,kBAAL;AACD,aAND;AAOD;;;6CAGkB;AACjB,iBAAKxE,KAAL,CAAW9B,OAAX,GAAqB,EAArB;AACA,iBAAK+D,MAAL;AACD;;;uCACYwC,M,EAAQ;AACnB,iBAAKzE,KAAL,CAAW9B,OAAX,GAAqB4B,EAAE4E,OAAF,CAAU,KAAK1E,KAAL,CAAW9B,OAArB,EAA8BuG,MAA9B,CAArB;AACA,iBAAK5E,SAAL,CAAeoC,MAAf;AACD;;;6CACkB;AAAA;;AACjB,gBAAI,CAAC,KAAKpC,SAAL,CAAeZ,OAApB,EAA6B;AAC3B,qBAAO,KAAK0F,EAAL,CAAQC,IAAR,CAAa,EAAb,CAAP;AACD;AACD,gBAAI1G,UAAU,KAAKf,YAAL,CAAkB,KAAK6C,KAAL,CAAW1C,SAA7B,EAAwCuH,UAAxC,CAAmD,KAAKhF,SAAL,CAAeZ,OAAlE,CAAd;AACA,gBAAI6F,WAAWhF,EAAEC,GAAF,CAAM7B,OAAN,EAAe,UAAC6G,CAAD;AAAA,qBAAO,OAAKlG,YAAL,CAAkBmG,UAAlB,CAA6B;AAChEzF,uBAAOwF,EAAEzF;AADuD,eAA7B,CAAP;AAAA,aAAf,CAAf;AAGA,mBAAO,KAAKqF,EAAL,CAAQC,IAAR,CAAaE,QAAb,CAAP;AACD;;;sCAEW;AACV,gBAAI5G,UAAUf,aAAa,KAAK6C,KAAL,CAAW1C,SAAxB,EAAmCuH,UAAnC,CAA8C,KAAKhF,SAAL,CAAeZ,OAA7D,CAAd;AACA,gBAAIwF,SAAS3E,EAAEmF,IAAF,CAAO/G,OAAP,EAAgB;AAC3BoB,oBAAM,KAAKJ,gBAAL,CAAsBK;AADD,aAAhB,CAAb;;AAIA,gBAAIkF,MAAJ,EAAY;AACV,mBAAKzE,KAAL,CAAW9B,OAAX,CAAmB2C,IAAnB,CAAwB4D,MAAxB;AACA,mBAAKxC,MAAL;AACD;;AAED,gBAAIiD,aAAa,KAAKrG,YAAL,CAAkBM,aAAlB,EAAjB;AACA,iBAAKD,gBAAL,CAAsBiG,IAAtB,GAA6BD,WAAWC,IAAxC;AACA,iBAAKjG,gBAAL,CAAsBK,KAAtB,GAA8B2F,WAAW3F,KAAzC;AACD;;;4CAEiB6F,K,EAAO;AACvB,iBAAKpF,KAAL,CAAWvC,MAAX,GAAoBqC,EAAE4E,OAAF,CAAU,KAAK1E,KAAL,CAAWvC,MAArB,EAA6B2H,KAA7B,CAApB;AACD;;;wCACaX,M,EAAQY,O,EAAS;AAC7BZ,mBAAO5G,IAAP,GAAcwH,QAAQ9F,KAAtB;AACA,iBAAKM,SAAL,CAAeoC,MAAf;AACD;;;2CACgBqD,K,EAAO;AACtB,gBAAIC,MAAM,KAAKvF,KAAL,CAAWvC,MAAX,CAAkB6H,KAAlB,EAAyBvH,MAAnC;AACA,gBAAIyH,OAAOD,IAAI,CAAJ,CAAX;AACAA,gBAAI,CAAJ,IAASA,IAAI,CAAJ,CAAT;AACAA,gBAAI,CAAJ,IAASC,IAAT;AACA,iBAAK3F,SAAL,CAAeoC,MAAf;AACD;;;;QA3TqCrF,gB;;;;AA6TxC4B,yBAAmBiH,WAAnB,GAAiC,wBAAjC","file":"ctrl.js","sourcesContent":["import {\n  MetricsPanelCtrl\n} from 'app/plugins/sdk';\nimport $ from 'jquery';\nimport moment from 'moment';\nimport kbn from 'app/core/utils/kbn';\n\nimport DataTable from './libs/datatables.net/js/jquery.dataTables.min.js';\nimport './libs/datatables.net-dt/css/jquery.dataTables.min.css!';\n// See this for styling https://datatables.net/manual/styling/theme-creator\nimport './css/datatable.css!';\nimport './css/panel.css!';\nimport * as FileExport from 'app/core/utils/file_export';\n\nimport {\n  transformDataToTable,\n  transformers\n} from './transformers';\n\nconst panelDefaults = {\n  targets: [{}],\n  transform: 'timeseries_to_columns',\n  pageSize: null,\n  showHeader: true,\n  styles: [\n    {\n      type: 'date',\n      pattern: 'Time',\n      dateFormat: 'YYYY-MM-DD HH:mm:ss',\n      },\n    {\n      unit: 'short',\n      type: 'number',\n      decimals: 2,\n      colors: [\"rgba(245, 54, 54, 0.9)\", \"rgba(237, 129, 40, 0.89)\", \"rgba(50, 172, 45, 0.97)\"],\n      colorMode: null,\n      pattern: '/.*/',\n      thresholds: [],\n      }\n    ],\n  columns: [],\n  scroll: true,\n  fontSize: '100%',\n  sort: {\n    col: 0,\n    desc: true\n  },\n};\n\nexport class DatatablePanelCtrl extends MetricsPanelCtrl {\n\n  constructor($scope, $injector, $http, $location, uiSegmentSrv, annotationsSrv) {\n    super($scope, $injector);\n    this.pageIndex = 0;\n    this.table = null;\n    this.dataRaw = [];\n    this.transformers = transformers;\n    this.annotationsSrv = annotationsSrv;\n    this.uiSegmentSrv = uiSegmentSrv;\n    // editor\n\n    this.addColumnSegment = uiSegmentSrv.newPlusButton();\n    this.fontSizes = ['80%', '90%', '100%', '110%', '120%', '130%', '150%', '160%', '180%', '200%', '220%', '250%'];\n    this.colorModes = [\n      {\n        text: 'Disabled',\n        value: null\n      },\n      {\n        text: 'Cell',\n        value: 'cell'\n      },\n      {\n        text: 'Value',\n        value: 'value'\n      },\n      {\n        text: 'Row',\n        value: 'row'\n      },\n    ];\n    this.columnTypes = [\n      {\n        text: 'Number',\n        value: 'number'\n      },\n      {\n        text: 'String',\n        value: 'string'\n      },\n      {\n        text: 'Date',\n        value: 'date'\n      },\n      {\n        text: 'Hidden',\n        value: 'hidden'\n      }\n    ];\n    this.unitFormats = kbn.getUnitFormats();\n    this.dateFormats = [\n      {\n        text: 'YYYY-MM-DD HH:mm:ss',\n        value: 'YYYY-MM-DD HH:mm:ss'\n      },\n      {\n        text: 'MM/DD/YY h:mm:ss a',\n        value: 'MM/DD/YY h:mm:ss a'\n      },\n      {\n        text: 'MMMM D, YYYY LT',\n        value: 'MMMM D, YYYY LT'\n      },\n    ];\n    // this is used from bs-typeahead and needs to be instance bound\n    this.getColumnNames = () => {\n      if (!this.panelCtrl.table) {\n        return [];\n      }\n      return _.map(this.panelCtrl.table.columns, function(col) {\n        return col.text;\n      });\n    };\n\n    if (this.panel.styles === void 0) {\n      this.panel.styles = this.panel.columns;\n      this.panel.columns = this.panel.fields;\n      delete this.panel.columns;\n      delete this.panel.fields;\n    }\n    _.defaults(this.panel, panelDefaults);\n\n    this.dataLoaded = true;\n    this.http = $http;\n\n    this.events.on('data-received', this.onDataReceived.bind(this));\n    this.events.on('data-error', this.onDataError.bind(this));\n    this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n    this.events.on('init-panel-actions', this.onInitPanelActions.bind(this));\n\n  }\n\n  onInitPanelActions(actions) {\n      actions.push({\n        text: 'Export CSV',\n        click: 'ctrl.exportCsv()'\n      });\n    }\n    // setup the editor\n  onInitEditMode() {\n    // determine the path to this plugin\n    var panels = grafanaBootData.settings.panels;\n    var thisPanel = panels[this.pluginId];\n    var thisPanelPath = thisPanel.baseUrl + '/';\n    // add the relative path to the partial\n    var optionsPath = thisPanelPath + 'partials/editor.options.html';\n    this.addEditorTab('Options', optionsPath, 2);\n  }\n\n  issueQueries(datasource) {\n    this.pageIndex = 0;\n    if (this.panel.transform === 'annotations') {\n      this.setTimeQueryStart();\n      return this.annotationsSrv.getAnnotations({\n          dashboard: this.dashboard,\n          panel: this.panel,\n          range: this.range\n        })\n        .then(annotations => {\n          return {\n            data: annotations\n          };\n        });\n    }\n    return super.issueQueries(datasource);\n  }\n\n  onDataError(err) {\n    this.dataRaw = [];\n    this.render();\n  }\n\n  onDataReceived(dataList) {\n    this.dataRaw = dataList;\n    this.pageIndex = 0;\n\n    // automatically correct transform mode based on data\n    if (this.dataRaw && this.dataRaw.length) {\n      if (this.dataRaw[0].type === 'table') {\n        this.panel.transform = 'table';\n      } else {\n        if (this.dataRaw[0].type === 'docs') {\n          this.panel.transform = 'json';\n        } else {\n          if (this.panel.transform === 'table' || this.panel.transform === 'json') {\n            this.panel.transform = 'timeseries_to_rows';\n          }\n        }\n      }\n    }\n    this.render();\n  }\n\n  render() {\n    this.table = transformDataToTable(this.dataRaw, this.panel);\n    this.table.sort(this.panel.sort);\n    return super.render(this.table);\n  }\n\n  exportCsv() {\n    var renderer = new TableRenderer(this.panel, this.table, this.dashboard.isTimezoneUtc(), this.$sanitize);\n    FileExport.exportTableDataToCsv(renderer.render_values());\n  }\n\n  link(scope, elem, attrs, ctrl) {\n    var data;\n    var panel = ctrl.panel;\n    var formatters = [];\n    var _this = this;\n\n    function renderPanel() {\n\n      if (_this.table.columns.length === 0) return;\n      // multiple types here\n      // timeseries_to_rows (column 0 = timestamp)\n      // timeseries_to_columns\n      // timeseries_aggregations - column 0 is the metric name (series name, not a timestamp)\n      // annotations - specific headers for this\n      // table\n      // json (raw)\n      // columns[x].type === \"date\" then set columndefs to parse the date, otherwise leave it as default\n      // convert table.columns[N].text to columns formatted to datatables.net format\n      var columns = [];\n      var columnDefs = [];\n      for (let i = 0; i < _this.table.columns.length; i++) {\n        /* jshint loopfunc: true */\n        columns.push({\n          title: _this.table.columns[i].text,\n          type: _this.table.columns[i].type\n        });\n        if (_this.table.columns[i].type !== null) {\n          switch (_this.table.columns[i].type) {\n            case \"date\":\n              columnDefs.push(\n                {\n                  \"type\": \"date\",\n                  \"targets\": i,\n                  \"render\": function(data, type, full, meta) {\n                    var response = data;\n                    try {\n                      //console.log(\"Data is : \" + data);\n                      if (data === undefined) {\n                        return null;\n                      }\n                      response = moment.utc(data, \"x\").toISOString().replace(/T/, ' ').replace(/Z/, '');\n                    } catch (err) {\n                      return response;\n                    }\n                    return response;\n                  }\n                }\n              );\n              break;\n            default:\n              columnDefs.push({null});\n              break;\n          }\n        } else {\n          columnDefs.push({null});\n        }\n      }\n\n      try {\n        var should_destroy = false;\n        if ( $.fn.dataTable.isDataTable( '#datatable-panel-table')) {\n          should_destroy = true;\n        }\n        if (should_destroy) {\n          var aDT = $('#datatable-panel-table').DataTable();\n          aDT.destroy();\n          $('#datatable-panel-table').empty();\n        }\n      }\n      catch(err) {\n        console.log(\"Exception: \" + err.message);\n      }\n      // sanity check\n      // annotations come back as 4 items in an array per row. If the first row content is undefined, then modify to empty\n      // since datatables.net throws errors\n      if (_this.table.rows[0].length === 4) {\n        if (_this.table.rows[0][0] === undefined) {\n          // detected empty annotations\n          _this.table.rows = [];\n        }\n      }\n      $('#datatable-panel-table').DataTable({\n        data: _this.table.rows,\n        columnDefs: columnDefs,\n        columns: columns\n      });\n\n      _this.dataLoaded = true;\n      console.log(\"Datatable Loaded!\");\n    }\n\n    ctrl.events.on('render', function(renderData) {\n      data = renderData || data;\n      if (data) {\n        renderPanel();\n      }\n      ctrl.renderingCompleted();\n    });\n  }\n\n  // editor methods\n  transformChanged() {\n    this.panel.columns = [];\n    this.render();\n  }\n  removeColumn(column) {\n    this.panel.columns = _.without(this.panel.columns, column);\n    this.panelCtrl.render();\n  }\n  getColumnOptions() {\n    if (!this.panelCtrl.dataRaw) {\n      return this.$q.when([]);\n    }\n    var columns = this.transformers[this.panel.transform].getColumns(this.panelCtrl.dataRaw);\n    var segments = _.map(columns, (c) => this.uiSegmentSrv.newSegment({\n      value: c.text\n    }));\n    return this.$q.when(segments);\n  }\n\n  addColumn() {\n    var columns = transformers[this.panel.transform].getColumns(this.panelCtrl.dataRaw);\n    var column = _.find(columns, {\n      text: this.addColumnSegment.value\n    });\n\n    if (column) {\n      this.panel.columns.push(column);\n      this.render();\n    }\n\n    var plusButton = this.uiSegmentSrv.newPlusButton();\n    this.addColumnSegment.html = plusButton.html;\n    this.addColumnSegment.value = plusButton.value;\n  }\n\n  removeColumnStyle(style) {\n    this.panel.styles = _.without(this.panel.styles, style);\n  }\n  setUnitFormat(column, subItem) {\n    column.unit = subItem.value;\n    this.panelCtrl.render();\n  }\n  invertColorOrder(index) {\n    var ref = this.panel.styles[index].colors;\n    var copy = ref[0];\n    ref[0] = ref[2];\n    ref[2] = copy;\n    this.panelCtrl.render();\n  }\n}\nDatatablePanelCtrl.templateUrl = 'partials/template.html';\n"]}